deployment:
  production:
    branch: new-infra
    commands:
      - alias terraform=~/terraform/terraform
      - make deploy

machine:
  environment:
    PATH: "${PATH}:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin"

dependencies:
  pre:
    - curl -O https://releases.hashicorp.com/terraform/0.9.4/terraform_0.9.4_linux_amd64.zip
    - mkdir -p ~/terraform
    - unzip terraform_0.9.4_linux_amd64.zip -d ~/terraform
    - curl https://raw.githubusercontent.com/apex/apex/master/install.sh | sudo sh
  override:
    - yarn
  cache_directories:
    - ~/.cache/yarn

test:
  override:
    - git fetch --unshallow
    - yarn test
